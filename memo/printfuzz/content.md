# PrIntFuzz: fuzzing Linux drivers via automated virtual device simulation [ISSTA'22]

## Abstract

- Linux ドライバはカーネルのコアと同じアドレス空間と特権を共有しているが, コードベースと攻撃対象は遥かに大きい
- ドライバは十分にテストされておらず, セキュリティが弱い
- ハードウェアデバイスがないと, 既存のファジングはドライバコードの大部分をカバーすることができない
  - 初期化コードや割り込みハンドラなど

<br/>

- 本論文では probing や 割り込みハンドラを含む, 見過ごされているドライバコードをテストできるファジングフレームワークの PrIntFuzz を紹介
- PrIntFuzz は最初に, 静的解析によって, ドライバから知識を抽出
  - inter-procedural
  - field-sensitive
  - path-sensitive
  - flow-sensitive
- 次にその情報を利用して, シミュレータを構築し, 以下をサポート
  - デバイスプロービング
  - ハードウェア割り込みエミュレーション
  - デバイス I/O インターセプト
- PrIntFuzz は多次元ファジング戦略を適用し, 見落とされたコードを探索する

<br/>

- 以下のデバイスのシミュレーションに成功
  - 311個の仮想PCI
    - PCI (Peripheral Component Interconnect) : PC のメインボードに接続されるインターフェース規格
    - CPU, メモリ以外の周辺機器 (ビデオカード (GPU), サウンドカード, ネットワークカード)
      - これらのカードで, 映像出力, 音声入出力, ネットワークへの物理的接続ができる
  - 472個の仮想I2C
    - I2C (Inter-Integrated Circuit) : 短距離で低速なインターフェース
    - センサ, LCD など (ラズパイでつなげたものか?)
  - 472個の仮想USB
    - USB (Universal Serial Bus) : USB インターフェースを使用して接続する周辺機器
       - キーボード, マウス, プリンタ, 外付けハードディスク
- これらに対応するバグを 150個発見
- Linux5.10-rc6 では 99個のバグを発見したが, 他の最先端のファザーは50個しか発見できなかった
- PrIntFuzz は 11,968 個の基本ブロックをカバー
  - その他のファザーは 2,353個の基本ブロックしかカバーしていない

<br/>

## 1. Intruduction

- Linux のセキュリティはますます注目を集める
- CVE の統計では最も脆弱性のある上位6製品のうち5製品は Liunx ディストリビューションとその亜種
- これらの脆弱性のうちドライバが最も多い
  - Jeff は Android の85%の脆弱性がドライバに存在することを指摘
  - Alireza は Linux の脆弱性のほとんどがドライバに起因することを指摘
- ドライバはカーネルのコアと同じアドレス空間と特権を共有するため, 攻撃者にとって魅力的なターゲット
  - 攻撃者はシステムコールや, 不正なデバイスからの不正な割り込みや不正なデータを介して, ドライバの脆弱性を悪用する
  - さらなる攻撃を仕掛けるためにカーネル特権を獲得する

<br/>

- ファジングはハードウェアデバイスのサポートによってターゲットドライバをテストすることができる
- しかし, 実際にテストできる実デバイスの数は限られるため, 実デバイスに依存するファザーでは, ほとんどのドライバのコードをカバーすることができない
- 最近の研究では, よりスケーラブルで実用的な仮想デバイスに依存したファザーが提案される
- しかし, これらのアプローチは仮想デバイスを開発する際に, 3つの課題に遭遇する

<br/>

- 第1に, ファザーがサポートする仮想デバイスの多様性は限られており, 多くのドライバが実行できない
- 限られた数の仮想デバイスを作成するための手作業に頼っている
  - USBFuzz は仮想 USB デバイスをシミュレート
  - VIA は手動で提供された設定ファイルに基づいて, ごく僅かな PCI デバイスをシミュレート
- 大規模な仮想デバイスの多様性を高めるには, 仮想デバイスを自動生成する必要がある

<br/>

- 第2に, シミュレートされた仮想デバイスの機能は限られており, 対応するドライバのコードカバレッジは低くなっている
- 調査によると, ドライバコードの重要な部分
  - 初期化とクリーンアップ : 36%
  - リクエスト処理と割り込み : 23.3%
  - コンフィグレーション : 15%
  - 電源管理 : 7.4%
  - ioctl : 6.2%
  - エラー処理 : 5%
- 既存手法はデバイスの一部機能しかシミュレートしていない
  - USBFuzz は仮想 USB デバイスのプラグとアンプラグ操作のみ
- ファザーは初期化コードや割り込みハンドラを含むデバイスドライバのコードをテストするために, 仮想デバイスの機能を包括的にシミュレートする必要がある

<br/>

- 第3に, ドライバの攻撃対象が十分に探索されていない
- ドライバは様々なソースから入力を受け入れる可能性がある
  - システムコールの引数を介して, ユーザから提供されるデータ
  - MMIO, PMIO, DMA を介して, デバイスから提供されるデータ
- 攻撃者はこれらの入力ソースのいずれかから攻撃を仕掛ける可能性がある

<br/>

- 本論文では PrIntFuzz を設計・開発する
- 上記の課題を解決する
- 初期化 (probing) コードと割り込みハンドラを含む, ドライバコードの大部分をテストする

<br/>

- 第1に, PrIntFuzz は静的解析を利用して, ドライバが必要とするデバイス情報を抽出し,
- 仮想デバイスを自動的に生成する手法を設計することで, ファザーが様々なドライバをテストできるようにする

<br/>

- 第2に, PrIntFuzz は仮想デバイスの主要な機能をシミュレートする自動化手法を開発し, ターゲットドライバの大半のコードをカバーできるようにする
  - ドライバの初期化中にソフトウェアフォールトを注入
  - ドライバのテスト中に仮想ハードウェア割り込み信号を注入する
- これによって, ファザーはドライバの初期化コードと割り込みハンドラを探索することができる 

<br/>

- 第3に, PrIntFuzz は協調的な多次元ファジングスキームを提案し, ファザーがドライバの攻撃対象領域を徹底的に探索することを可能にする
  - 具体的には以下を特定の順序で編成する
    - ユーザとの対話 (システムコールなど)
    - デバイスの機能 (割り込み発生, フォルトインジェクション)
    - 異なるソースからのデバイスデータの注入
- PrIntFuzz はこれらを統一されたシステムコールシーケンスにカプセル化し, 高品質のテストケースを生成する

<br/>

- PrIntFuzz を Linux5.18-rc1 で評価した
- PrIntFuzz は649個の PCI ドライバを発見し, 311個のシミュレーションに成功
- また, 472個の I2C デバイスと, 169個の USB デバイスにシミュレーションに成功
- 既存手法と比較して, コードカバレッジ・バグ発見が向上
- PrIntFuzz は150個のバグを発見
  - PCIドライバ : 112個
  - I2Cドライバ : 20個
  - USBドライバ : 18個
- 対照実験では, PrIntFuzz は 99個のバグを発見したのに対し, VIA は50個のみ